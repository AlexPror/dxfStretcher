# Инструкция: Автоматическая пакетная обработка разверток

## Обзор обновления

Добавлена система **автоматического определения целевых длин** на основе анализа файлов оснований. Теперь не нужно вручную вводить целевую длину для каждого файла — программа сама определяет правильную длину из соответствующих дуг оснований.

---

## Принцип работы

### 1. Структура файлов

Для работы автоматической обработки в папке должны быть:

```
папка/
├── Основание Г1.корп1 - 1шт.dxf    (эталонные файлы)
├── Основание Г1.корп2 - 1шт.dxf
├── Основание Г1.корп3 - 1шт.dxf
├── Внешний радиус Г1.корп1 - 1шт.dxf    (файлы для обработки)
├── Внешний радиус Г1.корп2 - 1шт.dxf
├── Внешний радиус Г1.корп3 - 1шт.dxf
├── Внутренний радиус Г1.корп1 - 1шт.dxf
├── Внутренний радиус Г1.корп2 - 1шт.dxf
└── Внутренний радиус Г1.корп3 - 1шт.dxf
```

### 2. Логика сопоставления

Каждое основание содержит **2 основные дуги** (большие радиусы гиба):

- **ДУГА 1** (больший радиус) → для **ВНЕШНЕГО радиуса**
- **ДУГА 2** (меньший радиус) → для **ВНУТРЕННЕГО радиуса**

Программа автоматически:
1. Анализирует все файлы оснований
2. Извлекает длины дуг 1 и 2 из каждого основания
3. Находит файлы радиусов
4. Определяет номер корпуса по имени файла (`корп1`, `корп2`, `корп3`)
5. Сопоставляет каждый радиус с соответствующей дугой основания

**Пример:**
```
Внешний радиус Г1.корп2 → Основание Г1.корп2 → ДУГА 1 → 1850.711 мм
Внутренний радиус Г1.корп2 → Основание Г1.корп2 → ДУГА 2 → 1705.672 мм
```

---

## Использование программы

### Запуск программы

1. Дважды кликните на `run.bat`
2. Откроется окно программы
3. Перейдите на вкладку **"Пакетная обработка"**

### Шаг 1: Анализ оснований

1. Нажмите **"Обзор"** и выберите папку с DXF файлами
2. Нажмите **"1. Анализировать основания"**
3. В логе появится информация о найденных основаниях:
   - Количество оснований
   - Радиусы и длины дуг
   - Список файлов радиусов для обработки

**Пример вывода:**
```
[КОРП2] Основание Г1.корп2 - 1шт.dxf
  ├─ Дуга 1 (для ВНЕШНЕГО радиуса):
  │  Радиус: 3297.200 мм
  │  Длина:  1850.711 мм
  │
  └─ Дуга 2 (для ВНУТРЕННЕГО радиуса):
     Радиус: 3038.800 мм
     Длина:  1705.672 мм
     Разница: 145.039 мм
```

### Шаг 2: Настройка параметров

Установите параметры обработки:
- **Направление растяжения**: X или Y (обычно X)
- **Центр масштабирования**: Левый край / Центр / Правый край

> ℹ️ Целевые длины определяются автоматически из оснований

### Шаг 3: Запуск обработки

1. Нажмите **"2. Запустить обработку"**
2. Программа автоматически:
   - Измеряет текущую длину каждого файла
   - Сопоставляет его с соответствующей дугой основания
   - Определяет нужную операцию (удлинение/укорочение)
   - Выполняет обработку
   - Сохраняет результат с суффиксом `_stretch`

**Пример вывода:**
```
[1/6] Внешний радиус Г1.корп2 - 1шт.dxf
    Тип: Внешний радиус
    Корпус: корп2
    Основание: Основание Г1.корп2 - 1шт.dxf
    Целевая длина: 1850.711 мм (ДУГА 1 основания)
    УДЛИНЕНИЕ: 1840.496 -> 1850.711 мм
    Delta: +10.215 мм (+0.55%)
    Коэффициент: 1.005549
    ✅ Результат: Внешний радиус Г1.корп2 - 1шт_stretch.dxf
```

### Шаг 4: Создание отчёта

1. Нажмите **"3. Создать отчёт"**
2. Будет создан текстовый файл с детальной информацией:
   - Использованные основания и их дуги
   - Результаты обработки каждого файла
   - Сводная статистика

Файл отчёта: `ОТЧЁТ_ОБРАБОТКА_ГГГГММДД_ЧЧММСС.txt`

---

## Ожидаемые результаты

### Внешние радиусы (УДЛИНЕНИЕ)

| Корпус | Исходная, мм | Целевая, мм | Δ, мм     |
|--------|--------------|-------------|-----------|
| корп1  | 1760.948     | 1764.016    | +3.068    |
| корп2  | 1840.496     | 1850.711    | +10.215   |
| корп3  | 1816.708     | 1850.711    | +34.003   |

### Внутренние радиусы (УКОРОЧЕНИЕ)

| Корпус | Исходная, мм | Целевая, мм | Δ, мм     |
|--------|--------------|-------------|-----------|
| корп1  | 1724.691     | 1721.623    | -3.068    |
| корп2  | 1716.449     | 1705.672    | -10.777   |
| корп3  | 1719.893     | 1705.672    | -14.221   |

---

## Преимущества автоматической обработки

✅ **Исключение ошибок**: нет риска использовать неправильную дугу  
✅ **Экономия времени**: не нужно вручную извлекать и вводить длины  
✅ **Масштабируемость**: легко обрабатывать любое количество корпусов  
✅ **Трассируемость**: полная информация о сопоставлениях в отчёте  
✅ **Автоматическая валидация**: программа проверяет наличие оснований  

---

## Обработка нескольких корпусов одновременно

Программа автоматически определяет, сколько корпусов присутствует в папке (1, 2, 3 или более).

**Важно**: Все файлы должны следовать соглашению об именовании:
- Основание: `Основание ... корп<N> ...`
- Внешний радиус: `Внешний радиус ... корп<N> ...`
- Внутренний радиус: `Внутренний радиус ... корп<N> ...`

где `<N>` — номер корпуса (1, 2, 3, и т.д.)

---

## Проверка результатов

После обработки проверьте:

1. **Количество обработанных файлов** в итоговом сообщении
2. **Лог обработки** — все ли файлы успешно обработаны
3. **Результирующие файлы** с суффиксом `_stretch`
4. **Отчёт** — детальная информация о каждой обработке

---

## Устранение проблем

### "Не найдено файлов оснований"
- Убедитесь, что в папке есть файлы с именем `Основание*.dxf`
- Проверьте правильность расширения (.dxf или .DXF)

### "Не найдено основание для корпХ"
- Проверьте, что имя файла радиуса содержит `корпХ`
- Убедитесь, что есть соответствующий файл основания

### "Найдено менее 2 дуг в файле"
- Проверьте, что файл основания содержит минимум 2 дуги (ARC entities)
- Возможно, файл повреждён или содержит другую геометрию

---

## Технические детали

### Алгоритм извлечения дуг

1. Открывает DXF файл основания
2. Находит все примитивы типа `ARC`
3. Сортирует по радиусу (от большего к меньшему)
4. Берёт 2 самые большие дуги:
   - Дуга 1: наибольший радиус → для внешнего радиуса
   - Дуга 2: второй по величине → для внутреннего радиуса

### Вычисление длины дуги

```
L = R × θ

где:
  L — длина дуги
  R — радиус
  θ — угол в радианах
```

### Формат выходных файлов

- Исходный файл: `Внешний радиус Г1.корп2 - 1шт.dxf`
- Результат: `Внешний радиус Г1.корп2 - 1шт_stretch.dxf`

---

## Дополнительная информация

**Модули:**
- `core/base_analyzer.py` — анализ оснований
- `core/dxf_processor.py` — обработка DXF
- `core/flat_pattern_service.py` — бизнес-логика
- `app.py` — графический интерфейс

**Тестирование:**
- `test_base_analyzer.py` — тестовый скрипт для проверки анализатора

---

**Версия:** 3.0 (Автоматическая обработка)  
**Дата обновления:** 20.11.2024

